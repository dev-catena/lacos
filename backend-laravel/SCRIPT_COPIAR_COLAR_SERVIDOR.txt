# Copie e cole este script completo no servidor:

cd /var/www/lacos-backend

CONTROLLER_FILE="app/Http/Controllers/Api/CaregiverController.php"
BACKUP_FILE="${CONTROLLER_FILE}.bak.$(date +%Y%m%d_%H%M%S)"

# Fazer backup
sudo cp "$CONTROLLER_FILE" "$BACKUP_FILE"
echo "✅ Backup: $BACKUP_FILE"

# Encontrar linha com busca em doctors
DOCTOR_LINE=$(grep -n "\$doctor = DB::table('doctors')" "$CONTROLLER_FILE" | cut -d: -f1)

if [ -n "$DOCTOR_LINE" ]; then
    # Encontrar linha do if
    IF_LINE=$(sed -n "${DOCTOR_LINE},\$p" "$CONTROLLER_FILE" | grep -n "if (\$isDoctor\|if (\$doctor)" | head -1 | cut -d: -f1)
    IF_LINE=$((DOCTOR_LINE + IF_LINE - 1))
    
    # Remover comentário se existir
    COMMENT_LINE=$(sed -n "1,${DOCTOR_LINE}p" "$CONTROLLER_FILE" | grep -n "Verificar se o usuário é médico" | tail -1 | cut -d: -f1)
    
    if [ -n "$COMMENT_LINE" ] && [ "$COMMENT_LINE" -lt "$DOCTOR_LINE" ]; then
        START_DELETE=$COMMENT_LINE
    else
        START_DELETE=$DOCTOR_LINE
    fi
    
    # Remover linhas
    sudo sed -i "${START_DELETE},$((IF_LINE - 1))d" "$CONTROLLER_FILE"
    
    # Adicionar verificação correta
    NEW_IF_LINE=$((START_DELETE))
    sudo sed -i "${NEW_IF_LINE}i\\            // Verificar se o usuário é médico (doctor_id nos appointments é o user_id)\\n            \$isDoctor = \$user->profile === 'doctor';" "$CONTROLLER_FILE"
fi

# Corrigir if
sudo sed -i "s/if (\$doctor) {/if (\$isDoctor) {/" "$CONTROLLER_FILE"

# Corrigir uso de doctor->id
sudo sed -i "s/\$doctor->id/\$user->id/g" "$CONTROLLER_FILE"

# Verificar sintaxe
php -l "$CONTROLLER_FILE"

# Limpar cache
php artisan route:clear
php artisan config:clear
php artisan cache:clear

echo "✅ Correção concluída!"


