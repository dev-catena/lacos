# ============================================================================
# SCRIPT PARA ADICIONAR ROTAS DO SENSOR DE QUEDA
# COPIAR E COLAR TUDO ISSO NO TERMINAL DO SERVIDOR
# ============================================================================

cd /var/www/lacos-backend

# Descobrir qual arquivo de rotas usar
ROUTES_FILE=""
if [ -f "routes/api.php" ]; then
    ROUTES_FILE="routes/api.php"
elif [ -f "routes_api_corrigido.php" ]; then
    ROUTES_FILE="routes_api_corrigido.php"
else
    echo "‚ùå Arquivo de rotas n√£o encontrado!"
    exit 1
fi

echo "üìã Arquivo de rotas: $ROUTES_FILE"

# Verificar se as rotas j√° existem
if grep -q "fall-sensor/data" "$ROUTES_FILE" && \
   grep -q "fall-sensor/history" "$ROUTES_FILE" && \
   grep -q "fall-sensor/latest" "$ROUTES_FILE" && \
   grep -q "fall-sensor/alerts" "$ROUTES_FILE"; then
    echo "‚úÖ Rotas do sensor de queda j√° existem!"
    exit 0
fi

# Fazer backup
echo "üíæ Criando backup..."
sudo cp "$ROUTES_FILE" "${ROUTES_FILE}.backup.$(date +%Y%m%d_%H%M%S)"
echo "‚úÖ Backup criado"

# Adicionar import se n√£o existir
if ! grep -q "FallSensorController" "$ROUTES_FILE"; then
    echo "üìù Adicionando import do FallSensorController..."
    # Adicionar ap√≥s AdminAuthController (√∫ltimo import)
    sudo sed -i '/use App\\Http\\Controllers\\Api\\AdminAuthController;/a use App\\Http\\Controllers\\Api\\FallSensorController;' "$ROUTES_FILE"
    echo "‚úÖ Import adicionado"
fi

# Adicionar rotas ap√≥s Vital Signs
echo "üìù Adicionando rotas ap√≥s Vital Signs..."

# Encontrar linha de Vital Signs
VITAL_SIGNS_LINE=$(grep -n "// Vital Signs" "$ROUTES_FILE" | cut -d: -f1)

if [ -n "$VITAL_SIGNS_LINE" ]; then
    # Encontrar linha ap√≥s Route::apiResource('vital-signs'
    ROUTE_LINE=$(sed -n "${VITAL_SIGNS_LINE},$((VITAL_SIGNS_LINE+5))p" "$ROUTES_FILE" | grep -n "Route::apiResource('vital-signs'" | head -1 | cut -d: -f1)
    if [ -n "$ROUTE_LINE" ]; then
        INSERT_LINE=$((VITAL_SIGNS_LINE + ROUTE_LINE))
    else
        INSERT_LINE=$((VITAL_SIGNS_LINE + 2))
    fi
    
    # Adicionar rotas
    sudo sed -i "${INSERT_LINE}a\\
    \\
    // Fall Sensor (Sensor de Queda)\\
    Route::post('/groups/{groupId}/fall-sensor/data', [FallSensorController::class, 'store']);\\
    Route::get('/groups/{groupId}/fall-sensor/history', [FallSensorController::class, 'index']);\\
    Route::get('/groups/{groupId}/fall-sensor/latest', [FallSensorController::class, 'getLatest']);\\
    Route::get('/groups/{groupId}/fall-sensor/alerts', [FallSensorController::class, 'getFallAlerts']);\\
" "$ROUTES_FILE"
    echo "‚úÖ Rotas adicionadas ap√≥s Vital Signs"
else
    # Se n√£o encontrar Vital Signs, adicionar antes de Documents
    DOCS_LINE=$(grep -n "// Documents" "$ROUTES_FILE" | cut -d: -f1)
    if [ -n "$DOCS_LINE" ]; then
        sudo sed -i "${DOCS_LINE}i\\
    // Fall Sensor (Sensor de Queda)\\
    Route::post('/groups/{groupId}/fall-sensor/data', [FallSensorController::class, 'store']);\\
    Route::get('/groups/{groupId}/fall-sensor/history', [FallSensorController::class, 'index']);\\
    Route::get('/groups/{groupId}/fall-sensor/latest', [FallSensorController::class, 'getLatest']);\\
    Route::get('/groups/{groupId}/fall-sensor/alerts', [FallSensorController::class, 'getFallAlerts']);\\
    \\
" "$ROUTES_FILE"
        echo "‚úÖ Rotas adicionadas antes de Documents"
    else
        # √öltima tentativa: adicionar antes do fechamento do grupo auth:sanctum
        CLOSING_LINE=$(grep -n "^});" "$ROUTES_FILE" | tail -1 | cut -d: -f1)
        if [ -n "$CLOSING_LINE" ]; then
            sudo sed -i "$((CLOSING_LINE-1))a\\
    // Fall Sensor (Sensor de Queda)\\
    Route::post('/groups/{groupId}/fall-sensor/data', [FallSensorController::class, 'store']);\\
    Route::get('/groups/{groupId}/fall-sensor/history', [FallSensorController::class, 'index']);\\
    Route::get('/groups/{groupId}/fall-sensor/latest', [FallSensorController::class, 'getLatest']);\\
    Route::get('/groups/{groupId}/fall-sensor/alerts', [FallSensorController::class, 'getFallAlerts']);\\
" "$ROUTES_FILE"
            echo "‚úÖ Rotas adicionadas antes do fechamento do grupo"
        else
            echo "‚ùå N√£o foi poss√≠vel encontrar local para adicionar rotas"
            echo "   Adicione manualmente no arquivo $ROUTES_FILE"
            exit 1
        fi
    fi
fi

# Verificar sintaxe PHP
echo ""
echo "üîç Verificando sintaxe PHP..."
php -l "$ROUTES_FILE" > /dev/null 2>&1
if [ $? -eq 0 ]; then
    echo "‚úÖ Sintaxe OK!"
else
    echo "‚ùå Erro de sintaxe detectado!"
    php -l "$ROUTES_FILE"
    echo ""
    echo "üíæ Restaurando backup..."
    LATEST_BACKUP=$(ls -t ${ROUTES_FILE}.backup.* 2>/dev/null | head -1)
    if [ -n "$LATEST_BACKUP" ]; then
        sudo cp "$LATEST_BACKUP" "$ROUTES_FILE"
        echo "‚úÖ Backup restaurado"
    fi
    exit 1
fi

# Verificar se as rotas foram adicionadas
echo ""
echo "üîç Verificando rotas adicionadas..."
if grep -q "fall-sensor/data" "$ROUTES_FILE" && \
   grep -q "fall-sensor/history" "$ROUTES_FILE" && \
   grep -q "fall-sensor/latest" "$ROUTES_FILE" && \
   grep -q "fall-sensor/alerts" "$ROUTES_FILE"; then
    echo "‚úÖ Todas as rotas foram adicionadas com sucesso!"
    echo ""
    echo "üìã Rotas encontradas:"
    grep "fall-sensor" "$ROUTES_FILE" | sed 's/^/   /'
else
    echo "‚ö†Ô∏è  Algumas rotas podem n√£o ter sido adicionadas. Verifique manualmente."
fi

echo ""
echo "‚úÖ Processo conclu√≠do!"
echo ""
