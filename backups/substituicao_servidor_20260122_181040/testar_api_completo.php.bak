<?php

/**
 * Script para testar a API completa e ver exatamente o que estÃ¡ sendo retornado
 */

require __DIR__ . '/../vendor/autoload.php';

$app = require_once __DIR__ . '/../bootstrap/app.php';
$app->make(\Illuminate\Contracts\Console\Kernel::class)->bootstrap();

use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Auth;
use App\Http\Controllers\Api\GroupController;
use Illuminate\Http\Request;

$email = $argv[1] ?? 'amigo@gmail.com';
$groupId = $argv[2] ?? 1;

echo "ğŸ§ª TESTE COMPLETO DA API\n";
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n";

$user = DB::table('users')->where('email', $email)->first();

if (!$user) {
    echo "âŒ UsuÃ¡rio nÃ£o encontrado!\n";
    exit(1);
}

echo "ğŸ‘¤ UsuÃ¡rio: {$user->name} ({$user->email})\n";
echo "   ID: {$user->id}\n\n";

// Simular autenticaÃ§Ã£o
Auth::loginUsingId($user->id);

// Criar request simulado
$request = Request::create("/api/groups/{$groupId}", 'GET');
$request->setUserResolver(function () use ($user) {
    return (object)['id' => $user->id, 'email' => $user->email];
});

// Chamar o controller diretamente
$controller = new GroupController();
$response = $controller->show($groupId);

// Obter conteÃºdo da resposta
$content = $response->getContent();
$data = json_decode($content, true);

echo "ğŸ“¦ Resposta da API:\n";
echo json_encode($data, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE);
echo "\n\n";

echo "ğŸ” AnÃ¡lise:\n";
echo "   is_admin: " . ($data['is_admin'] ?? 'NÃƒO DEFINIDO') . " (tipo: " . gettype($data['is_admin'] ?? null) . ")\n";
echo "   is_creator: " . ($data['is_creator'] ?? 'NÃƒO DEFINIDO') . " (tipo: " . gettype($data['is_creator'] ?? null) . ")\n";
echo "   created_by: " . ($data['created_by'] ?? 'NÃƒO DEFINIDO') . "\n";
echo "   user_id: {$user->id}\n";
echo "   ComparaÃ§Ã£o created_by == user_id: " . (($data['created_by'] ?? null) == $user->id ? 'true' : 'false') . "\n";

echo "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n";

